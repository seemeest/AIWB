# План проекта: Маркетплейс (аналог Wildberries)

## Обзор
Веб-платформа маркетплейса с тремя ролями: Продавец, Покупатель, Модератор. Фронтенд на React, бэкенд на Java. Платежи через Юкассу. Своя логистика и склады.

## Цели
- Обеспечить полнофункциональный маркетплейс для продавцов и покупателей.
- Обеспечить модерацию контента и споров.
- Гарантировать время отклика не более 1 секунды для ключевых операций.

## Роли и функциональность
### Продавец
- Создание товара и загрузка фото.
- Управление ценой, временными скидками, количеством товара.
- Выбор категории, бренда, вариантов (цвет/размер), характеристик для техники.
- Просмотр метрик: просмотры, позиция в поиске, конверсия, статистика покупок с детализацией по времени.
- Публикация первого товара только после подтверждения модератором.
- Редактирование товара или черновика без повторной модерации.

### Покупатель
- Поиск товаров, фильтры, автодополнение.
- Просмотр товара, комментариев и отзывов.
- Возможность оставить отзыв только после покупки.
- Личный кабинет: заказы, корзина, избранное, история покупок.
- Рекомендации товаров под клиента.
- Блок «Похожие товары» в карточке товара.

### Модератор
- Модерация комментариев и споров.
- Блокировка продавца, покупателя, товара с указанием причины.
- Обработка жалоб на товары.
- Модерация первого товара продавца.

## Аутентификация и доступ
- Регистрация по email с обязательным подтверждением через одноразовый токен.
- Роли доступа: buyer/seller/moderator.
- Восстановление пароля по email.
- Update 2026-01-17: При восстановлении/смене пароля все активные сессии должны быть отозваны через версионирование токенов (refresh не должен работать).
- Update 2026-01-17: Refresh-токены хранятся в отдельной таблице с версией токена, временем выдачи и сроками действия.
- Update 2026-01-17: Для модераторов хранится информация о последнем входе пользователя (user agent, локация, устройство/браузер).

## Процесс публикации и модерации
- Новый товар создается как черновик и не виден покупателям до публикации.
- Первый товар продавца попадает в модерацию перед публикацией.
- Последующие товары продавца публикуются сразу после перевода из черновика.
- Редактирование опубликованного товара не требует повторной модерации.
- Жалобу на товар может отправить любой пользователь.
- Модератор может блокировать товар, продавца или покупателя, фиксируя причину.
- Жалобы и решения модерации сохраняются с историей статусов.
- Апелляция возможна один раз на инцидент в течение 7 дней.
- Блокировки в основном временные с эскалацией: 3-7 дней (первый инцидент), 14-30 дней (повторные).
- Перманентная блокировка при системных нарушениях, мошенничестве, подделках или большом числе подтвержденных жалоб.

## Поиск и каталог
- Полнотекстовый поиск с опечатками (пример: "кросовки" → "кроссовки", "айфон" → "iphone").
- Автодополнение: популярные запросы, категории, бренды.
- Каталог с категориями, брендами, вариантами (цвет/размер) и характеристиками для техники.

## Оплата и финансы
- Единственный провайдер: Юкасса.
- Комиссия платформы: 5% от суммы заказа.
- Продавец получает 100% суммы товара, комиссия списывается отдельно.

## Доставка и возвраты
- Логистика: своя.
- Возвраты доступны при повреждении товара или неправильной поставке.
- Основная цепочка статусов: created -> paid -> accepted -> assembled -> shipped -> in_transit -> arrived_at_pvz -> ready_for_pickup -> picked_up -> completed.
- Дополнительные ветки: cancelled, returned, lost, expired (не забрали из ПВЗ).
- Возврат: return_requested -> return_in_transit -> returned -> refunded.

## Уведомления
- Каналы: email и веб-уведомления.
- События: регистрация, создание/оплата заказа, изменение статуса доставки, готовность к выдаче в ПВЗ, отмена/возврат, ответ продавца, блокировка товара/аккаунта, решение по апелляции.
- Формат: короткие шаблонные сообщения с полями номер заказа, статус, срок, ссылка на действие.

## Метрики продавца
- Просмотры: уникальные просмотры карточки товара по пользователю/сессии за период.
- Позиция в поиске: среднее место товара по релевантным запросам с учетом показов.
- Конверсия: количество заказов / количество просмотров карточки за период.
- Дополнительно: отмены, возвраты и рейтинг влияют на ранжирование и видимость товара.

## Нефункциональные требования
- Высокие требования к безопасности.
- Время отклика: не более 1 секунды для ключевых операций.
- Масштаб: ~10k заказов в день, много продавцов и пользователей.
- RPO: 15 минут, RTO: 1 час.

## Архитектурные решения (черновик)
- Веб-клиент: React.
- Бэкенд: Java (конкретные фреймворки/библиотеки уточнить).
- Платежи: интеграция с Юкассой.
- Update 2026-01-17: Аутентификация на JWT + refresh token.
- Update 2026-01-17: Бэкенд стек: Spring Boot 3, Java 21, Gradle, JPA/Hibernate, Flyway.
- Update 2026-01-17: База данных PostgreSQL.
- Update 2026-01-17: Поиск: Elasticsearch (поддержка опечаток и автодополнения).
- Update 2026-01-17: Кеширование: Redis.
- Update 2026-01-17: Хранилище медиа: локальное.
- Update 2026-01-17: Событийная шина/очередь: Kafka.
- Update 2026-01-17: Оркестрация окружения: Docker Compose.
- Update 2026-01-17: Доставка с обязательными статусами.
- Update 2026-01-17: Принцип "Чистая архитектура" с разделением слоев domain/application/adapters/infrastructure.
- Update 2026-01-17: Наблюдаемость через OpenTelemetry и стек ELK (Elasticsearch + Kibana) для логов.
- Мониторинг и логирование: определить стек.
- Update 2026-01-17: Используется API Gateway для внешнего REST API.
- Update 2026-01-17: Внутренние коммуникации смешанные: асинхронные события через Kafka и синхронные gRPC вызовы.
- Update 2026-01-17: API Gateway выбран Spring Cloud Gateway.

## Architecture changes
- Update 2026-01-17: Переход к микросервисной архитектуре с EDA (event-driven) взаимодействием между сервисами.
- Update 2026-01-17: Внутрисервисные вызовы по gRPC (protobuf) для снижения накладных расходов; публичный API остается HTTP/REST.
- Update 2026-01-17: Монолит рассматривается как временный этап, требуется декомпозиция по доменам.
- Update 2026-01-17: Определены границы сервисов и владение данными (см. раздел "Границы сервисов").
- Update 2026-01-17: Определены базовые доменные события и требования к EDA (см. раздел "Доменные события").
- Update 2026-01-17: Зафиксированы правила версионирования gRPC контрактов (см. раздел "gRPC контракты").
- Update 2026-01-17: Принята стратегия согласованности на основе Outbox + Saga (см. раздел "Согласованность").

## Наблюдаемость
- Метрики производительности и трассировки через OpenTelemetry.
- Логи и визуализация в Elasticsearch + Kibana.

## Архитектурные принципы
- Чистая архитектура: доменная модель независима от инфраструктуры.
- Зависимости направлены внутрь (domain <- application <- adapters <- infrastructure).
- Транзакции, внешние интеграции и storage изолированы во внешних слоях.
- Данные принадлежат сервису-владельцу домена, межсервисное взаимодействие через события.

## Границы сервисов
- Auth: пользователи, роли, пароли, refresh-токены, аудит логинов.
- Catalog: товары, варианты, цены, скидки, статусы публикации, изображения.
- Search: индексация, поиск, автодополнение, похожие товары.
- Orders: корзина, заказы, позиции заказа, расчеты сумм.
- Payments: интеграция с Юкассой, статусы оплат.
- Delivery: склад, отгрузки, статусы доставки, возвраты.
- Moderation: жалобы, блокировки, апелляции, решения модераторов.
- Notifications: email/web-уведомления и шаблоны.
- Analytics: метрики продавца, просмотры, конверсия.
- GeoIP: асинхронное обогащение локации для аудита логинов.
- Media: хранение и выдача изображений (локальное хранилище как отдельный сервис).

## Доменные события
- user_registered, email_verified, password_reset_requested, password_changed.
- login_audit_created, login_geo_enriched.
- product_draft_created, product_published, product_updated, product_blocked.
- price_updated, discount_applied, inventory_changed.
- order_created, order_paid, order_cancelled.
- delivery_status_changed, return_requested, return_refunded.
- complaint_created, moderation_decision_made, appeal_submitted, appeal_resolved.
- notification_requested, notification_sent.

## gRPC контракты
- Контракты определяются в protobuf и версионируются в пакете: `com.aiwb.<service>.v1`.
- Изменения только обратно-совместимые: добавление полей с тегами, без переиспользования номеров.
- Новый breaking change -> новая версия пакета (`v2`), параллельная поддержка на переходный период.
- Для внутренних синхронных вызовов используем gRPC; внешний REST через API Gateway.

## Согласованность
- Используем Outbox-паттерн для публикации событий в Kafka из транзакций.
- Долгие бизнес-процессы реализуем как Saga (оркестрация в доменном сервисе).
- Все обработчики событий должны быть идемпотентными по ключу (event_id).

## План декомпозиции монолита
1) Выделение общих контрактов: protobuf схемы, общие события Kafka, единые модели ошибок.
2) Выделение Auth + Notifications в отдельные сервисы (низкая связность).
3) Выделение Catalog + Media (товары/картинки), подключение Search как отдельного сервиса индексации.
4) Выделение Orders + Payments + Delivery (цепочка заказа и логистики).
5) Выделение Moderation + Appeals.
6) Выделение Analytics + GeoIP.
7) Введение API Gateway в качестве единой точки входа и маршрутизация трафика на сервисы.
8) Постепенное отключение монолитных модулей после стабилизации сервисов.

## API Gateway (Spring Cloud Gateway)
- Входной REST API агрегирует маршруты по доменам: `/auth/**`, `/products/**`, `/orders/**`, `/search/**`, `/moderation/**`, `/notifications/**`, `/metrics/**`.
- Сквозная авторизация: JWT проверяется на уровне gateway.
- Rate limiting и базовые политики безопасности на уровне gateway.
- Проброс correlation-id для трассировки (OpenTelemetry).

## Границы Kafka и gRPC
- Kafka (асинхронно): события логина/GeoIP, создание/оплата заказов, изменения статусов доставки, публикация/обновление товаров, жалобы/решения, уведомления.
- gRPC (синхронно): запросы за данными каталога/наличия, проверки статусов блокировок, расчет доступности доставки.

## Модель данных (черновик)
- users: учетные записи (email, password_hash, status, created_at).
- roles/user_roles: базовые роли (buyer/seller/moderator) и назначения.
- seller_profiles: реквизиты продавца, статус, флаги модерации.
- products: базовый товар (seller_id, title, description, category_id, brand_id, status, is_first_product).
- product_variants: варианты (sku, color, size, price, quantity, status).
- product_images: изображения (product_id/variant_id, sort_order, path).
- categories/brands: иерархия и справочники.
- attributes/attribute_values/product_attributes: характеристики (в т.ч. для техники).
- discounts: временные скидки (product_id/variant_id, percent, start_at, end_at).
- orders/order_items: заказы и позиции (цены на момент покупки).
- payments: платежи (provider, external_id, status, amount).
- shipments/shipment_status_history: отгрузки и история статусов доставки.
- reviews/comments: отзывы и комментарии (link к order_item для валидации покупки).
- complaints: жалобы на товары (author_id, product_id, reason, status).
- moderation_actions: решения модерации (target_type, target_id, action, reason, created_at).
- blocks: блокировки (target_type, target_id, reason, until_at).
- product_views/search_metrics: просмотры, позиции в поиске, конверсия (по времени).
- notifications: email/web события и статус доставки.
- refresh_tokens: refresh токены (user_id, token_hash, token_version, issued_at, expires_at, revoked_at, user_agent, ip, device_fingerprint).
- login_audit: информация о последнем входе пользователя (user_id, last_login_at, user_agent, ip, device, browser, location).
  - location (nullable): country, region, city.

## API и контракты
- Публичный REST API использует корректные HTTP методы: POST для создания, GET для чтения, PUT/PATCH для обновления, DELETE для удаления/архивации.
- Внутренние контракты сервисов фиксируются в protobuf (gRPC) и версионируются.

## Риски
- 1 секунда отклика при полном тексте и автодополнении потребует продуманной архитектуры поиска и кеширования.
- Масштаб 10k заказов/день требует устойчивой очереди и надежной обработки платежей.
- Модерация и жалобы могут создать операционную нагрузку.

## Открытые вопросы
- ~~Какая модель аутентификации/авторизации (например, JWT/сессии), и нужны ли роли с fine-grained правами?~~
  - Update 2026-01-17: JWT + refresh token, роли только базовые.
- ~~Какая база данных (PostgreSQL/MySQL), нужен ли отдельный поисковый движок?~~
  - Update 2026-01-17: PostgreSQL + Elasticsearch, Redis для кеша.
- ~~Где хранить медиа: локально, объектное хранилище, CDN?~~
  - Update 2026-01-17: локальное хранилище.
- ~~Нужна ли поддержка очередей/шины событий (например, для платежей, уведомлений, логистики)?~~
  - Update 2026-01-17: Kafka.
- ~~Требуется ли SLA для логистики и трекинг статусов доставки?~~
  - Update 2026-01-17: статусные треки обязательны.
- ~~Нужны ли требования к резервному копированию и RPO/RTO?~~
  - Update 2026-01-17: RPO 15 минут, RTO 1 час.
- ~~Какие именно статусы доставки нужны и в каком порядке?~~
  - Update 2026-01-17: линейная цепочка + ветки cancelled/returned/lost/expired и возвраты.
- ~~Нужны ли апелляции и сроки блокировок (временные/перманентные)?~~
  - Update 2026-01-17: апелляция 1 раз в 7 дней, эскалация 3-7/14-30 дней, перманентные блокировки при тяжелых нарушениях.
- ~~Какой формат уведомлений и какие события обязательны для email/web?~~
  - Update 2026-01-17: события регистрации, заказа, доставки, отмен/возврата, блокировок, апелляций; формат коротких шаблонов.
- ~~Как формально считаются метрики продавца (просмотры, позиция, конверсия)?~~
  - Update 2026-01-17: просмотры уникальные, позиция средняя по релевантным запросам, конверсия = заказы/просмотры.
- Какие сервисные границы считаем целевыми (Auth, Catalog, Search, Order, Payment, Delivery, Moderation, Notification, Recommendation, Media, Analytics)?
- Какая стратегия согласованности данных между сервисами (eventual consistency, saga, outbox)?
- Какие события обязательны для публикации (создание/обновление товара, оплата, статусы доставки, блокировки, жалобы)?
- Нужен ли API gateway и централизованная авторизация для всех сервисов?
- Как формировать «Похожие товары» (категория/бренд/атрибуты/поведение), и где хранить модель?
- Какая схема определения локации пользователя (GeoIP, профиль, вручную)?
- Update 2026-01-17: GeoIP через GeoLite2, необязательные поля country/region/city.
- Нужен ли device_fingerprint и как формировать его?
