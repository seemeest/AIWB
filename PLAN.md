# План проекта: Маркетплейс (аналог Wildberries)

## Обзор
Веб-платформа маркетплейса с тремя ролями: Продавец, Покупатель, Модератор. Фронтенд на React, бэкенд на Java. Платежи через Юкассу. Своя логистика и склады.

## Цели
- Обеспечить полнофункциональный маркетплейс для продавцов и покупателей.
- Обеспечить модерацию контента и споров.
- Гарантировать время отклика не более 1 секунды для ключевых операций.

## Роли и функциональность
### Продавец
- Создание товара и загрузка фото.
- Управление ценой, временными скидками, количеством товара.
- Выбор категории, бренда, вариантов (цвет/размер), характеристик для техники.
- Просмотр метрик: просмотры, позиция в поиске, конверсия, статистика покупок с детализацией по времени.
- Публикация первого товара только после подтверждения модератором.

### Покупатель
- Поиск товаров, фильтры, автодополнение.
- Просмотр товара, комментариев и отзывов.
- Возможность оставить отзыв только после покупки.
- Личный кабинет: заказы, корзина, избранное, история покупок.
- Рекомендации товаров под клиента.

### Модератор
- Модерация комментариев и споров.
- Блокировка продавца, покупателя, товара с указанием причины.
- Обработка жалоб на товары.
- Модерация первого товара продавца.

## Аутентификация и доступ
- Регистрация по email с обязательным подтверждением через одноразовый токен.
- Роли доступа: buyer/seller/moderator.

## Процесс публикации и модерации
- Новый товар создается как черновик и не виден покупателям до публикации.
- Первый товар продавца попадает в модерацию перед публикацией.
- Последующие товары продавца публикуются сразу после перевода из черновика.
- Жалобу на товар может отправить любой пользователь.
- Модератор может блокировать товар, продавца или покупателя, фиксируя причину.
- Жалобы и решения модерации сохраняются с историей статусов.
- Апелляция возможна один раз на инцидент в течение 7 дней.
- Блокировки в основном временные с эскалацией: 3-7 дней (первый инцидент), 14-30 дней (повторные).
- Перманентная блокировка при системных нарушениях, мошенничестве, подделках или большом числе подтвержденных жалоб.

## Поиск и каталог
- Полнотекстовый поиск с опечатками (пример: "кросовки" → "кроссовки", "айфон" → "iphone").
- Автодополнение: популярные запросы, категории, бренды.
- Каталог с категориями, брендами, вариантами (цвет/размер) и характеристиками для техники.

## Оплата и финансы
- Единственный провайдер: Юкасса.
- Комиссия платформы: 5% от суммы заказа.
- Продавец получает 100% суммы товара, комиссия списывается отдельно.

## Доставка и возвраты
- Логистика: своя.
- Возвраты доступны при повреждении товара или неправильной поставке.
- Основная цепочка статусов: created -> paid -> accepted -> assembled -> shipped -> in_transit -> arrived_at_pvz -> ready_for_pickup -> picked_up -> completed.
- Дополнительные ветки: cancelled, returned, lost, expired (не забрали из ПВЗ).
- Возврат: return_requested -> return_in_transit -> returned -> refunded.

## Уведомления
- Каналы: email и веб-уведомления.
- События: регистрация, создание/оплата заказа, изменение статуса доставки, готовность к выдаче в ПВЗ, отмена/возврат, ответ продавца, блокировка товара/аккаунта, решение по апелляции.
- Формат: короткие шаблонные сообщения с полями номер заказа, статус, срок, ссылка на действие.

## Метрики продавца
- Просмотры: уникальные просмотры карточки товара по пользователю/сессии за период.
- Позиция в поиске: среднее место товара по релевантным запросам с учетом показов.
- Конверсия: количество заказов / количество просмотров карточки за период.
- Дополнительно: отмены, возвраты и рейтинг влияют на ранжирование и видимость товара.

## Нефункциональные требования
- Высокие требования к безопасности.
- Время отклика: не более 1 секунды для ключевых операций.
- Масштаб: ~10k заказов в день, много продавцов и пользователей.
- RPO: 15 минут, RTO: 1 час.

## Архитектурные решения (черновик)
- Веб-клиент: React.
- Бэкенд: Java (конкретные фреймворки/библиотеки уточнить).
- Платежи: интеграция с Юкассой.
- Update 2026-01-17: Аутентификация на JWT + refresh token.
- Update 2026-01-17: Бэкенд стек: Spring Boot 3, Java 21, Gradle, JPA/Hibernate, Flyway.
- Update 2026-01-17: База данных PostgreSQL.
- Update 2026-01-17: Поиск: Elasticsearch (поддержка опечаток и автодополнения).
- Update 2026-01-17: Кеширование: Redis.
- Update 2026-01-17: Хранилище медиа: локальное.
- Update 2026-01-17: Событийная шина/очередь: Kafka.
- Update 2026-01-17: Оркестрация окружения: Docker Compose.
- Update 2026-01-17: Доставка с обязательными статусами.
- Update 2026-01-17: Принцип "Чистая архитектура" с разделением слоев domain/application/adapters/infrastructure.
- Update 2026-01-17: Наблюдаемость через OpenTelemetry и стек ELK (Elasticsearch + Kibana) для логов.
- Мониторинг и логирование: определить стек.

## Наблюдаемость
- Метрики производительности и трассировки через OpenTelemetry.
- Логи и визуализация в Elasticsearch + Kibana.

## Архитектурные принципы
- Чистая архитектура: доменная модель независима от инфраструктуры.
- Зависимости направлены внутрь (domain <- application <- adapters <- infrastructure).
- Транзакции, внешние интеграции и storage изолированы во внешних слоях.

## Модель данных (черновик)
- users: учетные записи (email, password_hash, status, created_at).
- roles/user_roles: базовые роли (buyer/seller/moderator) и назначения.
- seller_profiles: реквизиты продавца, статус, флаги модерации.
- products: базовый товар (seller_id, title, description, category_id, brand_id, status, is_first_product).
- product_variants: варианты (sku, color, size, price, quantity, status).
- product_images: изображения (product_id/variant_id, sort_order, path).
- categories/brands: иерархия и справочники.
- attributes/attribute_values/product_attributes: характеристики (в т.ч. для техники).
- discounts: временные скидки (product_id/variant_id, percent, start_at, end_at).
- orders/order_items: заказы и позиции (цены на момент покупки).
- payments: платежи (provider, external_id, status, amount).
- shipments/shipment_status_history: отгрузки и история статусов доставки.
- reviews/comments: отзывы и комментарии (link к order_item для валидации покупки).
- complaints: жалобы на товары (author_id, product_id, reason, status).
- moderation_actions: решения модерации (target_type, target_id, action, reason, created_at).
- blocks: блокировки (target_type, target_id, reason, until_at).
- product_views/search_metrics: просмотры, позиции в поиске, конверсия (по времени).
- notifications: email/web события и статус доставки.

## Риски
- 1 секунда отклика при полном тексте и автодополнении потребует продуманной архитектуры поиска и кеширования.
- Масштаб 10k заказов/день требует устойчивой очереди и надежной обработки платежей.
- Модерация и жалобы могут создать операционную нагрузку.

## Открытые вопросы
- ~~Какая модель аутентификации/авторизации (например, JWT/сессии), и нужны ли роли с fine-grained правами?~~
  - Update 2026-01-17: JWT + refresh token, роли только базовые.
- ~~Какая база данных (PostgreSQL/MySQL), нужен ли отдельный поисковый движок?~~
  - Update 2026-01-17: PostgreSQL + Elasticsearch, Redis для кеша.
- ~~Где хранить медиа: локально, объектное хранилище, CDN?~~
  - Update 2026-01-17: локальное хранилище.
- ~~Нужна ли поддержка очередей/шины событий (например, для платежей, уведомлений, логистики)?~~
  - Update 2026-01-17: Kafka.
- ~~Требуется ли SLA для логистики и трекинг статусов доставки?~~
  - Update 2026-01-17: статусные треки обязательны.
- ~~Нужны ли требования к резервному копированию и RPO/RTO?~~
  - Update 2026-01-17: RPO 15 минут, RTO 1 час.
- ~~Какие именно статусы доставки нужны и в каком порядке?~~
  - Update 2026-01-17: линейная цепочка + ветки cancelled/returned/lost/expired и возвраты.
- ~~Нужны ли апелляции и сроки блокировок (временные/перманентные)?~~
  - Update 2026-01-17: апелляция 1 раз в 7 дней, эскалация 3-7/14-30 дней, перманентные блокировки при тяжелых нарушениях.
- ~~Какой формат уведомлений и какие события обязательны для email/web?~~
  - Update 2026-01-17: события регистрации, заказа, доставки, отмен/возврата, блокировок, апелляций; формат коротких шаблонов.
- ~~Как формально считаются метрики продавца (просмотры, позиция, конверсия)?~~
  - Update 2026-01-17: просмотры уникальные, позиция средняя по релевантным запросам, конверсия = заказы/просмотры.
