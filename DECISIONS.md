# Решения

## 2026-01-17
- decision: Инициализация журнала решений проекта.
  reason: Требуется фиксировать архитектурные и поведенческие решения в соответствии с правилами проекта.
  rejected alternatives: none

## 2026-01-17
- decision: Аутентификация на JWT + refresh token.
  reason: Нужна stateless авторизация для веб-платформы.
  rejected alternatives: Сессии на сервере.
- decision: PostgreSQL как основная БД, Elasticsearch для полнотекстового поиска, Redis для кеширования.
  reason: Требуется реляционная модель, быстрый поиск с опечатками и низкие задержки на чтение.
  rejected alternatives: MySQL; отсутствие отдельного поискового движка.
- decision: Локальное хранилище медиа.
  reason: Требование использовать локальное хранение.
  rejected alternatives: S3-совместимое объектное хранилище и CDN.
- decision: Kafka как шина событий.
  reason: Нужна надежная асинхронная обработка платежей, уведомлений и аналитики.
  rejected alternatives: Синхронная обработка без очереди.
- decision: Среда разворачивания через Docker Compose.
  reason: Требуется держать все сервисы в docker-compose.
  rejected alternatives: Раздельный запуск сервисов без оркестрации.
- decision: Статусы доставки обязательны для логистики.
  reason: Требование отслеживания заказа в собственной логистике.
  rejected alternatives: Отсутствие статусов доставки.
- decision: Резервное копирование с RPO 15 минут и RTO 1 час.
  reason: Нужна высокая надежность при ограничениях по времени восстановления.
  rejected alternatives: RPO/RTO без заданных значений.

## 2026-01-17
- decision: Публикация товаров через статусы draft/published с премодерацией первого товара продавца.
  reason: Нужно скрывать новые товары до публикации и контролировать первичное качество контента.
  rejected alternatives: Немедленная публикация первого товара без модерации.
- decision: Жалобы доступны всем пользователям, модератор может блокировать товар/продавца/покупателя с причиной.
  reason: Требуется гибкая реакция на нарушения и защита покупателей.
  rejected alternatives: Жалобы только от покупателей; блокировка только товаров.

## 2026-01-17
- decision: Ввести линейные статусы доставки и отдельную цепочку возвратов.
  reason: Требуется прозрачная трассировка заказов и возвратов в собственной логистике.
  rejected alternatives: Отсутствие детализированных статусов.
- decision: Ввести апелляции (1 раз/7 дней) и эскалацию блокировок 3-7/14-30 дней с перманентной блокировкой при тяжелых нарушениях.
  reason: Нужен контролируемый процесс модерации с возможностью пересмотра решений.
  rejected alternatives: Блокировки без апелляций и без сроков эскалации.
- decision: Уведомления email/web по ключевым событиям с короткими шаблонами.
  reason: Требуется единый формат и своевременная коммуникация с пользователями.
  rejected alternatives: Уведомления только в веб; свободный формат сообщений.
- decision: Метрики продавца считать по уникальным просмотрам, средней позиции и конверсии за период, с влиянием отмен/возвратов/рейтинга.
  reason: Нужна формализованная аналитика и влияние на ранжирование.
  rejected alternatives: Неформализованные метрики без единых определений.

## 2026-01-17
- decision: Применять чистую архитектуру с разделением слоев domain/application/adapters/infrastructure.
  reason: Требуется четкая изоляция бизнес-логики от инфраструктуры и гибкость развития.
  rejected alternatives: Монолит без четкого разделения слоев.
- decision: Бэкенд стек Spring Boot 3, Java 21, Gradle, JPA/Hibernate, Flyway.
  reason: Нужен современный и стабильный стек с поддержкой реляционных данных и миграций.
  rejected alternatives: Неопределенный стек; альтернативные фреймворки без необходимости.

## 2026-01-17
- decision: Подтверждение email через одноразовый токен с ограниченным сроком.
  reason: Требуется обязательное подтверждение email при регистрации.
  rejected alternatives: Логин без подтверждения email.

## 2026-01-17
- decision: Использовать OpenTelemetry для метрик производительности и трассировок, ELK (Elasticsearch + Kibana) для логов.
  reason: Нужна наблюдаемость с фокусом на производительность и визуализацию логов.
  rejected alternatives: Логи без централизованного хранения; метрики без трассировок.

## 2026-01-17
- decision: Переходим на микросервисную архитектуру с EDA вместо монолита.
  reason: Требования по масштабу и независимому развитию доменов требуют изоляции сервисов, асинхронной обработки и локальной оптимизации.
  rejected alternatives: Сохранение монолита с модульной структурой.
- decision: Внутренние вызовы между сервисами фиксируются в protobuf (gRPC), внешний API остается REST.
  reason: gRPC снижает накладные расходы и обеспечивает строгие контракты для внутренних интеграций.
  rejected alternatives: Только REST между сервисами.

## 2026-01-17
- decision: Используем версионирование токенов для отзыва всех активных refresh-токенов при смене/восстановлении пароля.
  reason: Требуется гарантированно завершать все активные сессии после компрометации или смены пароля.
  rejected alternatives: Хранить только blacklist токенов без версии пользователя.

## 2026-01-17
- decision: Refresh-токены храним в отдельной сущности RefreshToken с метаданными выдачи и версией токена.
  reason: Нужен аудит и надежный отзыв сессий, а также управление сроками жизни.
  rejected alternatives: Хранить только в памяти или без отдельной таблицы.
- decision: Для пользователей фиксируем последние данные входа (user agent, устройство, браузер, локация) для модерации.
  reason: Требование модерации и безопасности аккаунтов.
  rejected alternatives: Логи приложений без структурированного хранения.
- decision: Внешний доступ идет через API Gateway, внутренняя коммуникация смешанная: Kafka (события) и gRPC (синхронные вызовы).
  reason: Нужны EDA и эффективные межсервисные синхронные контракты.
  rejected alternatives: Только REST без API Gateway; только Kafka без синхронных вызовов.

## 2026-01-17
- decision: API Gateway выбираем Spring Cloud Gateway.
  reason: Нативная интеграция со Spring экосистемой и быстрый старт для Java-команды.
  rejected alternatives: Kong (операционные издержки); NGINX/Traefik (меньше политик и интеграций).
- decision: GeoIP обогащение выполняется асинхронно и best-effort через Kafka consumer.
  reason: GeoLite2 может отвечать медленно или не дать результат, поэтому не блокируем логин и не требуем локацию.
  rejected alternatives: Синхронный вызов GeoIP в процессе логина.

## 2026-01-17
- decision: Для событийной интеграции используем Outbox-паттерн и Saga для согласованности.
  reason: Нужна надежная публикация событий из транзакций и управляемые долгие процессы без распределенных транзакций.
  rejected alternatives: Прямые синхронные вызовы между сервисами без событий; распределенные транзакции.
